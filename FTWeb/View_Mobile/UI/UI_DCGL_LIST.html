<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>菜品列表</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.5.8/css/sm.min.css">
    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.5.8/css/sm-extend.min.css">
    <link href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.css" rel="stylesheet" />
    <link href="/View_Mobile/CSS/szhlextend.css?ver=20160904" rel="stylesheet" />
    <link rel="stylesheet" href="/View_Mobile/CSS/animate.css">

    <style type="text/css">

        .ms-controller, [ms-controller] {
            display: none;
        }
        .ui-row-flex {
            display: -webkit-box;
            width: 100%;
            -webkit-box-sizing: border-box;
        }
        .ui-col {
            float: none;
            -webkit-box-flex: 1;
            width: 0;
            box-sizing: border-box;
        }
        .ui-col-3 {
            -webkit-box-flex: 3;
        }
        .tplist > li {
            position: relative;
            padding-top: 10px;
            padding-bottom: 10px;
            padding-right: 15px;
            -webkit-box-align: center;
        }

        li {
            list-style: none;
        }

        .bq {
            text-align: center;
            position: absolute;
            top: 0.2rem;
            right: 0.2rem;
            width: 1rem;
            height: 1rem;
            line-height: 1rem;
            font-size: 0.5rem;
            color: #fff;
            background-color: #FF5151;
            border-radius: 0.5rem;
        }

        .current {
            background-color: white;
        }

        .addmin {
            position: absolute;
            right: 0.2rem;
            width: 0.9rem;
            height: 0.3rem;
        }

            .addmin input {
                width: 1rem;
                height: 1rem;
                font-size: 0.18rem;
                border: 1px solid #e5e5e5;
                text-align: center;
                color: #A1A09C;
                background-color: #fff;
            }
    </style>

</head>
<body ms-controller="model" >

    <div class="page page-current" id="pageindex1" style="background-color: #E5E5E5;">
        <div class="content">
            <div class="row no-gutter" style="width: 100%; margin-bottom: 40px; ">
                <div class="col-20" style="width: 25%; min-height: 500px; ">
                    <ul class=" tplist" style=" position: fixed; z-index: 100; left: 0; padding: 0; margin: 0; width: 25%;">
                        <li ms-repeat-el="ctData" ms-click="ckcp(this)" style="margin:0;padding-left:15px;" ms-attr-class="$index==0?' ui-border-b current':'ui-border-b'">
                            <div>
                                <a ms-attr-href="'#st'+el.ID" external>{{el.TypeName}}</a>
                            </div>
                            <b class="bq" ms-if="el.Qty!='0'">{{el.Qty}}</b>
                        </li>
                    </ul>
                </div>
                <div class="col-80" style="width: 75%;">
                    <div ms-repeat-st="ctData" ms-attr-id="'st'+st.ID" class="cplist">
                        <div style="text-align: center; color: #a7a7a7; border-left: solid 1px white; height: 44px; line-height: 44px; font-size: 20px;" class="ui-border-b">{{st.TypeName}}</div>

                        <div class="list-block media-list" style="padding:0;margin:0;">
                            <ul>
                                <li class="item-content" ms-repeat-item="st.Item" ms-visible="isbj||item.Status=='1'">
                                    <div class="item-media">
                                        <img ms-attr-src="'/ViewV5/Base/DownFile.aspx?fileId='+item.ImgUrl" style="width:80px;height:60px;">
                                    </div>
                                    <div class="item-inner" style="padding-right: .2rem; padding-top: .2rem; padding-bottom: .2rem;">
                                        <div class="item-title-row">
                                            <div class="item-title">{{item.Name}}</div>
                                        </div>
                                        <div class="item-subtitle">
                                            <p style="line-height: 20px; font-size: 12px; color: #777;margin:0; ">上架时间：{{item.CRDate.substring(5,10)}}</p>
                                        </div>

                                        <div class="item-subtitle" style="display: -webkit-box;">
                                            <div>
                                                <span style="color: #FF5151;"> ¥<span class="price">{{item.Price.toFixed(2)}}</span>/份</span>
                                            </div>
                                            <div style="-webkit-box-flex: 1;  display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-pack: center; ">
                                                <span class="addmin" ms-if="!isbj" style="width:auto;">
                                                    <input type="button" class="minus" value="-" ms-click="minus(item,st)">
                                                    <input type="button" class="result" readonly ms-duplex="item.Qty" style="border: none; color: #FF5151;padding:0;">
                                                    <input type="button" class="add" value="+" ms-click="add(item,st)">
                                                </span>
                                                <span class="addmin" ms-if="isbj" style=" width: auto;">
                                                    <input type="button" class="result" value="↓" style="border: none; color: #FF5151;" ms-if="item.Status=='0'">
                                                    <input type="button" value="编辑" ms-click="update(item)" style="width: auto; line-height: 0.28rem; padding: 0; min-width: 45px; color: white; background-color: #4cd964; border: none; border-radius: .25rem; ">
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li class="item-content" ms-if="st.Item.size()==0" style="margin: 0; text-align: center;">
                                    <div style="width: 100%; height: 72px; line-height: 72px;">无菜品</div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <nav class="bar bar-tab" ms-if="!isbj" style="height: 40px; z-index: 16;">
            <div class="content-block" style="margin: 0px; height: 40px; line-height: 40px; ">
                <div class="row">
                    <div style="width:75%;float:left;"> 合计:¥<span style="font-weight: bold; color: #ff4222;">{{totalprice.toFixed(2)}}</span>({{totalqty}}份)</div>
                    <div style="width: 25%; float: left;"><a href="javascript:void(0);" class="button button-fill button-success external" ms-click="savedata()">选好了</a></div>
                </div>
            </div>
        </nav>
        <nav class="bar bar-tab" ms-if="isbj" style="height: 40px; z-index: 16;">
            <div class="content-block" style="margin: 0px;  height: 40px; line-height: 40px;">
                <div>
                    <div class="col-100"><a href="javascript:void(0);" class="button button-fill button-success external" ms-click="addcp()">新增菜品</a></div>
                </div>
            </div>
        </nav>
    </div>
    
    <script src="/View_Mobile/JS/layer/layer.m.js"></script>
    <script type='text/javascript' src='//g.alicdn.com/sj/lib/zepto/zepto.min.js' charset='utf-8'></script>
    <script type='text/javascript' src='//g.alicdn.com/msui/sm/0.5.8/js/sm.min.js' charset='utf-8'></script>
    <script type='text/javascript' src='//g.alicdn.com/msui/sm/0.5.8/js/sm-extend.min.js' charset='utf-8'></script>
    <script src="/View_Mobile/JS/avalon.mobile.min.js"></script>
    <script src="/View_Mobile/JS/ComFunJS.js?jsver=20160425"></script>
    <script>
        //document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {
        //    //隐藏右上角按钮
        //    WeixinJSBridge.call('hideOptionMenu');
        //});

        var model = avalon.define({
            $id: "model",
            ctData: [],
            totalprice: 0,
            totalqty: 0,
            YJYCDate: "",
            isbj: "",
            addcp: function () {
                //window.location = "UI_DCGL_INPUT.html?r=" + Math.random();
                window.location = "/View_Mobile/UI/BASE/APP_MOBIL_WF.html?FormCode=DCGL&r=" + Math.random();
            },
            ckcp: function (obj) {
                $(obj).parent().find("li").removeClass("current");
                $(obj).addClass("current");
                $(obj).find("a").trigger("click");
            },
            add: function (im, el) {
                im.Qty = im.Qty * 1 + 1;
                el.Qty = el.Qty * 1 + 1;
                model.totalqty = model.totalqty * 1 + 1;
                model.totalprice = model.totalprice * 1 + im.Price * 1;
            },
            minus: function (im, el) {
                if (im.Qty * 1 > 0) {
                    im.Qty = im.Qty * 1 - 1;
                    el.Qty = el.Qty * 1 - 1;
                    model.totalqty = model.totalqty * 1 - 1;
                    model.totalprice = model.totalprice * 1 - im.Price * 1;
                }
            },
            update: function (im) {
                //window.location = "UI_DCGL_INPUT.html?id=" + im.ID + "&r=" + Math.random();
                window.location = "/View_Mobile/UI/BASE/APP_MOBIL_WF.html?FormCode=DCGL&id=" + im.ID + "&r=" + Math.random();
            },
            savedata: function () {
                var IDS = "";
                $(model.ctData).each(function (rt, ix) {
                    $(ix.Item).each(function (index, ele) {
                        if (ele.Qty * 1 > 0) {
                            if (IDS) {
                                IDS = IDS + "," + ele.ID + "_" + ele.Qty;
                            }
                            else {
                                IDS = ele.ID + "_" + ele.Qty;
                            }
                        }
                    })
                });
                if (!IDS) {
                    $.tips({
                        content: "请选择菜品",
                        stayTime: 2000,
                        type: "warn"
                    })
                    return;
                }
                var tc = layer.open({
                    content: '确定选好了吗？',
                    btn: ['确定', '取消'],
                    shadeClose: false,
                    yes: function () {
                        layer.close(tc);

                        var lg = $.loading({
                            content: '处理中...',
                        })

                        var date = new Date();
                        var d = {
                            "YJYCDate": model.YJYCDate,
                            "IDS": IDS
                        };

                        $.post("/API/WXAPI.ashx?Action=DCGL_ADDDCGLDD&r=" + Math.random(), { "P1": JSON.stringify(d) }, function (data) {
                            lg.hide();
                            var data = $.parseJSON(data);
                            if (data.ErrorMsg == "") {
                                $(".ui-footer").hide();
                                var el = $.tips({
                                    content: "下单成功！",
                                    stayTime: 2000,
                                    type: "success"
                                })
                                el.on("tips:hide", function () {
                                    window.history.back();
                                })

                            }
                            else {
                                if (data.Result) {
                                    var html = '';
                                    var cl = data.Result.split(',');
                                    $(cl).each(function (index, ele) {
                                        $(model.ctData).each(function (inx,cdt) {
                                            cdt.Item.each(function (ine,cp) {
                                                if (cp.ID.toString() == ele) {
                                                    if (html) {
                                                        html = html + ',' + cp.Name;
                                                    }
                                                    else {
                                                        html = cp.Name;
                                                    }

                                                    cdt.Qty = cdt.Qty * 1 - cp.Qty;
                                                    model.totalqty = model.totalqty * 1 - cp.Qty;
                                                    model.totalprice = model.totalprice * 1 - cp.Price * cp.Qty;
                                                    
                                                    cdt.Item.remove(cp);
                                                }
                                            })
                                        })
                                    })
                                    $.tips({
                                        content: "下单失败，" + html+"已下架",
                                        stayTime: 2000,
                                        type: "warn"
                                    })
                                }
                                else {
                                    $.tips({
                                        content: "下单失败，原因：" + data.ErrorMsg,
                                        stayTime: 2000,
                                        type: "warn"
                                    })
                                }
                            }
                        })
                    }, no: function () {
                    }
                })

            }

        });

        var strType = ComFunJS.getQueryString("type");

        avalon.ready(function () {
            $.showPreloader("加载中");
            $.getJSON("/API/WXAPI.ashx?Action=XTGL_GETCPROLE&r=" + Math.random(), {}, function (r) {
                if (r.ErrorMsg == "") {
                    if (r.Result == "Y") {
                        if (strType == "2") {
                            model.isbj = "Y";
                        }
                    }
                }
            })
            $.post("/API/WXAPI.ashx?Action=DCGL_GETDCGLLIST_PAGE&r=" + Math.random(), {}, function (data) {
                $.hidePreloader();
                var data = $.parseJSON(data);
                if (data.ErrorMsg == "") {
                    model.ctData = data.Result;
                }
            })

            $(".content").on('scroll', function () {
                for (var i = 0; i < $(".cplist").length; i++) {
                    var sheight = 0;
                    for (var j = 0; j < i; j++) {
                        sheight = sheight + $(".cplist").eq(j).height();
                    }
                    if ($(this).scrollTop() > sheight - 77) {
                        $(".tplist li").removeClass("current");
                        $(".tplist li").eq(i).addClass("current");
                    }
                }
                if ($(this).get(0).scrollHeight == $(this).scrollTop() + $(this).height()) {
                    $(".tplist li").removeClass("current");
                    $(".tplist li").eq($(".cplist").length - 1).addClass("current");
                }
            });
        })

        function back() {
            window.history.back();
        }
    </script>
</body>







</html>
